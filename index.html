<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Landslide</title>
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- GENERAL --- */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f0f0f0; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- SEARCH BAR --- */
        .search-container {
            position: absolute; top: 50px; left: 20px; right: 20px; z-index: 1000;
            background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; align-items: center; padding: 0 15px; height: 55px;
        }
        /* ADDED: cursor pointer to make it clickable */
        .search-icon { font-size: 18px; color: #666; margin-right: 10px; cursor: pointer; padding: 10px; }
        .search-input { border: none; outline: none; flex: 1; font-size: 16px; color: #333; }

        /* --- HUD --- */
        .nav-hud {
            position: absolute; top: 120px; left: 20px; right: 20px;
            background: #2196F3; color: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; display: none; text-align: center;
        }
        .nav-distance { font-size: 28px; font-weight: 800; letter-spacing: 1px; }
        .nav-label { font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;}
        .nav-stop { 
            background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
            padding: 6px 15px; border-radius: 20px; margin-top: 10px; cursor: pointer; font-size: 12px; font-weight: 600;
        }

        /* --- CONTROLS --- */
        .controls-container {
            position: absolute; bottom: 40px; right: 20px;
            display: flex; flex-direction: column; gap: 15px; z-index: 1000;
        }
        .fab-btn {
            width: 55px; height: 55px; background: white; border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; transition: transform 0.1s; position: relative;
        }
        .fab-btn:active { transform: scale(0.90); }
        .active-btn { background-color: #2196F3 !important; color: white !important; }
        .menu-btn { background-color: #111; color: white; }

        /* --- MODALS --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: flex-end; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        
        .modal-panel {
            background: #f9f9f9; width: 100%; height: 85vh; 
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            padding: 0; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal-panel { transform: translateY(0); }
        .modal-header { padding: 25px 20px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; }
        .modal-title { font-size: 22px; font-weight: 700; color: #111; }
        .close-icon { font-size: 24px; padding: 10px; cursor: pointer; color: #666; background: #f0f0f0; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .menu-list { padding: 20px; }
        .menu-item { background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .menu-icon { font-size: 22px; margin-right: 15px; width: 30px; text-align: center; }
        .menu-text { flex: 1; font-size: 16px; font-weight: 500; color: #333; }
        .menu-arrow { color: #ccc; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .setting-label { font-size: 16px; font-weight: 500; color: #333; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(22px); }
        .account-banner { background: linear-gradient(135deg, #111 0%, #333 100%); color: white; padding: 30px; border-radius: 16px; margin-bottom: 25px; text-align: center; }
        .avatar-large { width: 80px; height: 80px; background: #555; border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 35px; border: 3px solid white; }
        .upgrade-btn { background: #2196F3; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .danger-btn { color: red; text-align: center; padding: 20px; cursor: pointer; font-weight: 600; margin-top: 20px; }

        /* --- CARD --- */
        .info-card {
            position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 25px 20px 40px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 1001; transform: translateY(110%); transition: transform 0.3s ease-out;
        }
        .info-card.active { transform: translateY(0); }
        .card-handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 15px auto; }
        .prop-label { font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; letter-spacing: 0.5px; }
        .prop-value { font-size: 18px; color: #111; font-weight: 600; margin-bottom: 15px; line-height: 1.4; word-wrap: break-word; }
        .action-row { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; text-align: center; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #f3f4f6; color: #333; }

        .gps-pulse { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); animation: pulse-blue 2s infinite; border-radius: 50%; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); } }
        .popup-btn { background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; width: 100%; margin-top: 5px; cursor: pointer; font-weight: bold; }
        .custom-div-icon div { background-color:#c30b82; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <!-- SEARCH -->
    <div class="search-container">
        <!-- ADDED ONCLICK HERE -->
        <span class="search-icon" onclick="performSearch()">üîç</span>
        <input type="text" class="search-input" placeholder="Search Address or Owner...">
    </div>

    <!-- HUD -->
    <div class="nav-hud" id="navHud">
        <div class="nav-label">Distance to Stake</div>
        <div class="nav-distance" id="distText">0 ft</div>
        <button class="nav-stop" onclick="stopNavigation()">STOP NAVIGATION</button>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- BUTTONS -->
    <div class="controls-container">
        <div class="fab-btn" onclick="toggleLayer()" title="Switch View">üó∫Ô∏è</div>
        <div class="fab-btn" id="stakeBtn" onclick="toggleStakeMode()" title="Stake Mode">üî®</div>
        <div class="fab-btn" id="gpsBtn" onclick="toggleGPS()" title="Track Me">üìç</div>
        <div class="fab-btn menu-btn" onclick="openModal('mainMenu')">‚ò∞</div>
    </div>

    <!-- 1. MAIN MENU MODAL -->
    <div class="modal-overlay" id="mainMenu" onclick="closeModal('mainMenu')">
        <div class="modal-panel" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Menu</div>
                <div class="close-icon" onclick="closeModal('mainMenu')">‚úï</div>
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="openModal('accountModal')">
                    <div class="menu-icon">üë§</div><div class="menu-text">My Account</div><div class="menu-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="openModal('settingsModal')">
                    <div class="menu-icon">‚öôÔ∏è</div><div class="menu-text">Settings</div><div class="menu-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="shareLocation()">
                    <div class="menu-icon">üìç</div><div class="menu-text">Share My Location</div><div class="menu-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="inviteFriend()">
                    <div class="menu-icon">‚úâÔ∏è</div><div class="menu-text">Invite a Friend</div><div class="menu-arrow">‚Ä∫</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MY ACCOUNT MODAL -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal-panel" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="close-icon" onclick="closeModal('accountModal')">‚Üê</div>
                <div class="modal-title">My Account</div>
                <div style="width:40px"></div>
            </div>
            <div class="menu-list">
                <div class="account-banner">
                    <div class="avatar-large">üë§</div>
                    <h2>Guest User</h2>
                    <p>Free Plan</p>
                    <button class="upgrade-btn" onclick="alert('Payment Integration coming soon!')">Upgrade to Pro</button>
                </div>
                <div class="menu-item">
                    <div class="menu-text"><b>User ID:</b> <span id="userIdDisplay">Loading...</span></div>
                </div>
                <div class="danger-btn" onclick="clearAllData()">üóëÔ∏è Delete All My Stakes</div>
            </div>
        </div>
    </div>

    <!-- 3. SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-panel" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="close-icon" onclick="closeModal('settingsModal')">‚Üê</div>
                <div class="modal-title">Settings</div>
                <div style="width:40px"></div>
            </div>
            <div class="menu-list">
                <div class="setting-row">
                    <div class="setting-label">Units (Feet / Meters)</div>
                    <label class="switch"><input type="checkbox" id="unitToggle" onchange="saveSettings()"><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <div class="setting-label">Start in Satellite Mode</div>
                    <label class="switch"><input type="checkbox" id="mapToggle" checked onchange="saveSettings()"><span class="slider"></span></label>
                </div>
            </div>
        </div>
    </div>

    <!-- CARD -->
    <div class="info-card" id="card">
        <div class="card-handle"></div>
        <div class="prop-label">OWNER / PIN</div>
        <div class="prop-value" id="owner">Loading...</div>
        <div class="prop-label">ADDRESS / INFO</div>
        <div class="prop-value" id="address" style="font-size: 16px; font-weight: 400;">Loading...</div>
        <div class="action-row">
            <div class="action-btn btn-secondary" onclick="closeCard()">Close</div>
            <div class="action-btn btn-primary" id="saveBtn">Save</div> 
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- MAP SETUP ---
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });

        const map = L.map('map', {
            center: [40.764356, -73.973057], zoom: 15, layers: [satelliteLayer], zoomControl: false 
        });

        // --- VARS ---
        let currentBaseLayer = "satellite";
        let currentGeoJSON = null;
        let stakes = []; 
        let isStakingMode = false;
        let navTarget = null;
        let navLine = null;
        let userMarker = null;
        let accuracyCircle = null;
        let isTracking = false;
        
        // --- SETTINGS ---
        let useMetric = localStorage.getItem('useMetric') === 'true';
        document.getElementById('unitToggle').checked = useMetric;
        let userId = localStorage.getItem('userId');
        if(!userId) { userId = 'User-' + Math.floor(Math.random() * 100000); localStorage.setItem('userId', userId); }
        document.getElementById('userIdDisplay').innerText = userId;

        function saveSettings() {
            useMetric = document.getElementById('unitToggle').checked;
            localStorage.setItem('useMetric', useMetric);
        }

        function clearAllData() {
            if(confirm("Delete all stakes?")) {
                stakes.forEach(s => map.removeLayer(s.markerRef));
                stakes = []; localStorage.setItem('myStakes', '[]');
                alert("Cleared."); closeModal('accountModal');
            }
        }

        // --- MODALS ---
        function openModal(id) { document.getElementById(id).classList.add('open'); if(id !== 'mainMenu') document.getElementById('mainMenu').classList.remove('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); if(id !== 'mainMenu') document.getElementById('mainMenu').classList.add('open'); }

        // --- RESTORE ---
        const savedStakes = JSON.parse(localStorage.getItem('myStakes') || '[]');
        savedStakes.forEach(s => addStakeToMap(s.lat, s.lng, false));

        // --- SHARE ---
        async function shareLocation() {
            if (!userMarker) { alert("Enable GPS (üìç) first!"); return; }
            const { lat, lng } = userMarker.getLatLng();
            const link = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            if (navigator.share) await navigator.share({ title: 'Location', url: link }); else prompt("Copy link:", link);
        }
        async function inviteFriend() {
            const appUrl = window.location.href;
            if (navigator.share) await navigator.share({ title: 'Landslide', url: appUrl }); else prompt("Copy link:", appUrl);
        }

        // --- SEARCH (FIXED) ---
        const searchInput = document.querySelector('.search-input');
        
        // Function to run search
        async function performSearch() {
            const text = searchInput.value;
            if(text.length < 2) return; 
            searchInput.blur();
            try {
                const response = await fetch(`/api/search?q=${text}`);
                const results = await response.json();
                if (results.length > 0) {
                    const bestMatch = results[0];
                    // Fly to location
                    map.flyTo([bestMatch.lat, bestMatch.lng], 18);
                    // Show data
                    setTimeout(() => showParcelData(bestMatch), 1000);
                } else { alert("No matches found."); }
            } catch (err) { console.error(err); }
        }

        // Listen for Enter Key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // --- CONTROLS ---
        function toggleLayer() {
            if (currentBaseLayer === "satellite") { map.removeLayer(satelliteLayer); map.addLayer(streetLayer); currentBaseLayer = "street"; } 
            else { map.removeLayer(streetLayer); map.addLayer(satelliteLayer); currentBaseLayer = "satellite"; }
        }

        function toggleGPS() {
            if (!isTracking) {
                map.locate({ watch: true, enableHighAccuracy: true, setView: true, maxZoom: 20 });
                document.getElementById('gpsBtn').classList.add('active-btn'); isTracking = true;
            } else {
                map.stopLocate(); isTracking = false; document.getElementById('gpsBtn').classList.remove('active-btn');
                if(accuracyCircle) map.removeLayer(accuracyCircle);
            }
        }

        map.on('locationfound', (e) => {
            const radius = e.accuracy / 2;
            if (userMarker) { userMarker.setLatLng(e.latlng); accuracyCircle.setLatLng(e.latlng); accuracyCircle.setRadius(radius); } 
            else {
                userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#2196F3", color: "white", weight: 3, fillOpacity: 1, className: 'gps-pulse' }).addTo(map);
                accuracyCircle = L.circle(e.latlng, { radius: radius, color: '#2196F3', fillOpacity: 0.1, weight: 1 }).addTo(map);
            }
            if (navTarget) updateNavigation(e.latlng);
        });

        function toggleStakeMode() {
            isStakingMode = !isStakingMode;
            const btn = document.getElementById('stakeBtn');
            if (isStakingMode) { btn.classList.add('active-btn'); alert("Tap map to drop stake."); }
            else btn.classList.remove('active-btn');
        }

        function addStakeToMap(lat, lng, save = true) {
            const stakeIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#c30b82; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.5);'></div>", iconSize: [15, 15], iconAnchor: [6, 6] });
            const marker = L.marker([lat, lng], {icon: stakeIcon}).addTo(map);
            const popupContent = `<div style="text-align:center"><b>Stake Point</b><br><small>${lat.toFixed(5)}, ${lng.toFixed(5)}</small><br><button class="popup-btn" onclick="startNavigation(${lat}, ${lng})">GO TO</button><button style="margin-top:5px; color:red; border:none; background:none; cursor:pointer" onclick="deleteStake(${lat}, ${lng})">Delete</button></div>`;
            marker.bindPopup(popupContent);
            const stakeObj = { lat, lng, markerRef: marker };
            if (save) { stakes.push(stakeObj); saveStakesToStorage(); } 
            else { const existing = stakes.find(s => s.lat === lat && s.lng === lng); if(existing) existing.markerRef = marker; else stakes.push(stakeObj); }
        }

        function startNavigation(targetLat, targetLng) {
            if (!isTracking) { alert("Enable GPS first!"); toggleGPS(); }
            navTarget = L.latLng(targetLat, targetLng); document.getElementById('navHud').style.display = 'block'; map.closePopup();
            if (userMarker) updateNavigation(userMarker.getLatLng());
        }

        function updateNavigation(userLatLng) {
            const distanceMeters = userLatLng.distanceTo(navTarget);
            let displayDist = "";
            if(useMetric) displayDist = Math.round(distanceMeters) + " m";
            else { const feet = Math.round(distanceMeters * 3.28084); displayDist = feet + " ft"; }
            document.getElementById('distText').innerText = displayDist;
            if (navLine) map.removeLayer(navLine);
            navLine = L.polyline([userLatLng, navTarget], { color: 'white', weight: 4, dashArray: '10, 10', opacity: 0.8 }).addTo(map);
        }

        function stopNavigation() {
            navTarget = null; document.getElementById('navHud').style.display = 'none';
            if (navLine) map.removeLayer(navLine);
        }

        function deleteStake(lat, lng) {
            const stake = stakes.find(s => s.lat === lat && s.lng === lng);
            if (stake && stake.markerRef) map.removeLayer(stake.markerRef);
            stakes = stakes.filter(s => s.lat !== lat); saveStakesToStorage();
        }

        function saveStakesToStorage() {
            const dataToSave = stakes.map(s => ({ lat: s.lat, lng: s.lng }));
            localStorage.setItem('myStakes', JSON.stringify(dataToSave));
        }

        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            if (isStakingMode) { addStakeToMap(lat, lng); return; }
            try {
                const response = await fetch(`/api/parcels?lat=${lat}&lng=${lng}`);
                const data = await response.json();
                if(data.length > 0) showParcelData(data[0]); else closeCard();
            } catch (err) { console.error(err); }
        });

        function showParcelData(parcel) {
            document.getElementById('owner').innerText = parcel.owner_name || "Unknown";
            document.getElementById('address').innerText = parcel.address || "No Info";
            document.getElementById('card').classList.add('active');
            if (currentGeoJSON) map.removeLayer(currentGeoJSON);
            const geoJsonData = JSON.parse(parcel.geometry);
            currentGeoJSON = L.geoJSON(geoJsonData, { style: { color: "#ffcc00", weight: 4, fillOpacity: 0.1 } }).addTo(map);
        }

        function closeCard() { document.getElementById('card').classList.remove('active'); }
    </script>
</body>
</html>