<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Landslide</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #222; }
        #map { position: fixed; top: 60px; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* APP BAR */
        .app-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: white; display: flex; align-items: center; padding: 0 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 99999; border-bottom: 1px solid #ddd;
        }
        .menu-btn { font-size: 28px; padding: 10px 15px; cursor: pointer; color: #333; }
        .search-wrapper { flex: 1; margin: 0 5px; background: #f0f2f5; border-radius: 8px; padding: 5px 10px; display: flex; align-items: center; border: 1px solid #ddd; }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 16px; }
        .search-go-btn { background: #007bff; color: white; border-radius: 5px; padding: 5px 10px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 5px; }
        
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 2px; }
        .icon-svg { width: 24px; height: 24px; fill: #333; }

        /* TINY BOTTOM-RIGHT CARD */
        .info-card {
            position: fixed; bottom: 30px; right: 15px; width: auto; max-width: 180px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            border-radius: 12px; padding: 10px 15px;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #eee; text-align: right;
        }
        .info-card.active { transform: translateX(0); }
        .prop-val { font-size: 13px; font-weight: 800; color: #000; margin-bottom: 2px; line-height: 1.2; }
        .prop-sub { font-size: 11px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* SIDE MENU (SCROLLABLE v42) */
        .side-menu {
            position: fixed; top: 60px; left: 0; bottom: 0; width: 260px;
            background: white; z-index: 100000;
            transform: translateX(-100%); transition: transform 0.3s ease-out;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;
            overflow-y: auto; /* ENABLE SCROLLING */
            -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
        }
        .side-menu.open { transform: translateX(0); }
        
        /* Compact Menu Items */
        .menu-item { padding: 12px 20px; border-bottom: 1px solid #f0f0f0; font-weight: 500; color: #333; cursor: pointer; font-size: 15px; }
        .menu-item:active { background: #f9f9f9; }
        
        /* Menu Headers */
        .menu-header {
            padding: 15px 20px 5px; font-size: 11px; font-weight: 800; color: #888; letter-spacing: 1px; text-transform: uppercase;
        }

        .menu-overlay { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99998; display: none; }
        .menu-overlay.active { display: block; }

        /* SAVED DRAWER */
        .saved-modal {
            position: fixed; top: 60px; right: 0; bottom: 0; width: 85%; max-width: 320px;
            background: white; z-index: 10001; transform: translateX(100%); transition: transform 0.3s ease-out;
            display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.3);
        }
        .saved-modal.active { transform: translateX(0); }
        .saved-header { padding: 15px; background: #333; color: white; font-weight: bold; display: flex; justify-content: space-between; }
        .saved-list { flex: 1; overflow-y: auto; }
        .saved-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .trash-btn { padding: 10px; cursor: pointer; color: #ff4400; font-size: 16px; }

        /* LOGIN MODAL */
        .login-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100002; display: none; justify-content: center; align-items: center; }
        .login-modal.active { display: flex; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .login-link { color: #007bff; cursor: pointer; font-size: 12px; margin-top: 15px; display: block; }

        /* ASSETS */
        .stake-container { position: relative; }
        .stake-emoji { font-size: 35px; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); cursor: grab; }
        .stake-number { position: absolute; bottom: 0; right: 0; background: black; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        .gps-marker-wrap { position: relative; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; }
        .gps-dot-core { width: 16px; height: 16px; background-color: #007bff; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 2; }
        .gps-arrow { position: absolute; top: -8px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 12px solid #007bff; z-index: 1; transition: transform 0.1s linear; transform-origin: center 20px; }
        .leaflet-tooltip.gps-label { background-color: rgba(0, 123, 255, 0.9); border: none; color: white; font-weight: bold; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .leaflet-tooltip-bottom:before { border-bottom-color: rgba(0, 123, 255, 0.9); }
        .gps-pulse { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); animation: pulse-blue 2s infinite; border-radius: 50%; cursor: pointer !important; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); } }
        
        .debug-label { position: fixed; bottom: 5px; left: 5px; background: #FF5722; color: white; font-weight: bold; padding: 2px 6px; z-index: 99999; font-size: 10px; }
    </style>
</head>
<body>

    <div class="debug-label">v42</div>

    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadProjectFile(this)">

    <!-- MENU -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        
        <div class="menu-header">Map Tools</div>
        <div class="menu-item" onclick="flyToUser(); toggleMenu();">üìç Go to Current Location</div>
        <div class="menu-item" onclick="toggleSavedList(); toggleMenu();">üìÅ Saved Properties</div>
        <div class="menu-item" onclick="shareLocation()">üì° Share My Location</div>

        <div class="menu-header">Cloud Project</div>
        <div class="menu-item" style="color:#007bff; font-weight:bold" id="userDisplay" onclick="openLogin()">üë§ Login / Register</div>
        <div class="menu-item" onclick="saveToCloud()">‚òÅÔ∏è Save to Cloud</div>
        <div class="menu-item" onclick="loadFromCloud()">‚òÅÔ∏è Load from Cloud</div>

        <div class="menu-header">Local Files</div>
        <div class="menu-item" onclick="saveProjectFile()">üíæ Save to File</div>
        <div class="menu-item" onclick="document.getElementById('fileInput').click()">üìÇ Open File</div>
        <div class="menu-item" onclick="exportToCSV()">üì§ Export to Excel</div>
        
        <div class="menu-header">App</div>
        <div class="menu-item" onclick="shareApp()">üîó Invite Friends</div>
        <div class="menu-item" onclick="alert('Support: help@landslide.com')">üìû Contact Us</div>
        
        <!-- Spacer for scrolling -->
        <div style="height: 50px;"></div>
    </div>

    <!-- TOP BAR -->
    <div class="app-bar">
        <div class="menu-btn" onclick="toggleMenu()">‚â°</div>
        <div class="search-wrapper">
            <input type="text" class="search-input" id="searchBox" placeholder="Search...">
            <div class="search-go-btn" onclick="performSearch()">GO</div>
        </div>
        <div class="icon-btn" onclick="toggleLayer()" title="Switch Map"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/></svg></div>
    </div>

    <!-- SAVED LIST -->
    <div class="saved-modal" id="savedModal">
        <div class="saved-header"><span>Saved</span><span onclick="toggleSavedList()" style="cursor:pointer; font-size:20px;">‚úï</span></div>
        <div class="saved-list" id="savedListContainer"></div>
    </div>

    <!-- LOGIN MODAL -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h2 id="authTitle">Login</h2>
            <input type="email" id="email" class="login-input" placeholder="Email">
            <input type="password" id="password" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="handleAuth()">Submit</button>
            <div class="login-link" onclick="toggleAuthMode()" id="authLink">Need an account? Register</div>
            <div class="login-link" onclick="closeLogin()" style="color:#666">Cancel</div>
        </div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- TINY BOTTOM-RIGHT CARD -->
    <div class="info-card" id="card">
        <div class="prop-val" id="owner">...</div>
        <div class="prop-sub" id="address">...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // GLOBALS
        const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const street = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const map = L.map('map', { center: [40.764356, -73.973057], zoom: 18, layers: [satellite], zoomControl: false });

        let currentUser = null, userMarker = null, currentLatLng = null;
        let stakes = [], stakeMarkers = {}, activeLayer = null, currentParcelData = null, savedItems = [];

        // --- GPS ---
        map.locate({ watch: true, enableHighAccuracy: true });

        function enableCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(res => { if (res === 'granted') window.addEventListener('deviceorientation', handleOrientation); })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        function handleOrientation(e) {
            let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360);
            const arrow = document.getElementById('userHeadingArrow');
            if(arrow) arrow.style.transform = `rotate(${heading}deg)`;
        }

        map.on('locationfound', (e) => {
            currentLatLng = e.latlng;
            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                const gpsIcon = L.divIcon({
                    className: 'gps-marker-wrap',
                    html: `<div class="gps-arrow" id="userHeadingArrow"></div><div class="gps-dot-core"></div>`,
                    iconSize: [24, 24], iconAnchor: [12, 12]
                });
                userMarker = L.marker(e.latlng, { icon: gpsIcon, zIndexOffset: 1000 }).addTo(map);
                
                userMarker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    let nextNum = stakes.length + 1;
                    createStake(currentLatLng.lat, currentLatLng.lng, "Stake " + nextNum);
                });
                userMarker.bindTooltip("Tap to Stake", { permanent: true, direction: "bottom", className: "gps-label", offset: [0, 10] });
            }
        });

        function flyToUser() {
            if(currentLatLng) {
                map.flyTo(currentLatLng, 20);
                fetchParcelAt(currentLatLng.lat, currentLatLng.lng);
            } else {
                alert("Waiting for GPS...");
            }
        }

        // --- SHARE LOCATION ---
        function shareLocation() {
            if(!currentLatLng) return alert("Waiting for GPS...");
            const link = `https://maps.google.com/?q=${currentLatLng.lat},${currentLatLng.lng}`;
            const text = `I am staking property here: ${link}`;
            if (navigator.share) { navigator.share({ title: 'My Location', text: text, url: link }).catch(console.error); }
            else { prompt("Copy location link:", link); }
        }

        function shareApp() {
            if (navigator.share) { navigator.share({ title: 'Landslide App', text: 'Check out Landslide!', url: window.location.href }).catch(console.error); }
            else { prompt("Copy link:", window.location.href); }
        }

        // --- STAKE LOGIC ---
        function createStake(lat, lng, label) {
            const id = Date.now();
            const stakeData = { id, type: 'stake', lat, lng, label, number: stakes.length+1 };
            addStakeMarker(stakeData);
            stakes.push(stakeData);
            if(currentParcelData) saveProperty(true);
            saveToStorage();
        }
        function addStakeMarker(s) {
            const html = `<div class="stake-container"><div class="stake-emoji">üö©</div><div class="stake-number">${s.number || '?'}</div></div>`;
            const flag = L.marker([s.lat, s.lng], { draggable: true, icon: L.divIcon({ className: 'custom-icon', html: html, iconSize: [40, 40], iconAnchor: [5, 40] }) }).addTo(map);
            flag.bindPopup(`<b>#${s.number} ${s.label}</b><br><button onclick="window.removeStakeByBtn(${s.id})">Delete</button>`);
            flag.on('dragend', (e) => { const n = e.target.getLatLng(); s.lat = n.lat; s.lng = n.lng; saveToStorage(); });
            stakeMarkers[s.id] = flag;
        }
        window.removeStakeByBtn = function(id) { if(stakeMarkers[id]) map.removeLayer(stakeMarkers[id]); removeStake(id); }
        function removeStake(id) { stakes = stakes.filter(s => s.id !== id); delete stakeMarkers[id]; saveToStorage(); }

        // --- SEARCH ---
        const input = document.getElementById('searchBox');
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        async function performSearch() {
            const q = input.value; if(q.length < 2) return; input.blur();
            document.querySelector('.search-go-btn').innerText = "...";
            try {
                const res = await fetch(`/api/search?q=${q}`);
                const json = await res.json();
                document.querySelector('.search-go-btn').innerText = "GO";
                if(json.length > 0) { loadProperty(json[0]); map.flyTo([json[0].lat, json[0].lng], 19); } else alert("No results.");
            } catch(e) { document.querySelector('.search-go-btn').innerText = "GO"; }
        }

        // --- MAP & PARCELS ---
        function initApp() { 
            const stored = localStorage.getItem('landslide_saves'); 
            if (stored) {
                try {
                    const allData = JSON.parse(stored);
                    let allItems = Array.isArray(allData) ? allData : []; 
                    savedItems = allItems.filter(i => i.type !== 'stake');
                    const savedStakes = allItems.filter(i => i.type === 'stake');
                    savedStakes.forEach(s => { addStakeMarker(s); stakes.push(s); });
                } catch(e){}
            }
        }
        async function fetchParcelAt(lat, lng) { try { const res = await fetch(`/api/parcels?lat=${lat}&lng=${lng}`); const json = await res.json(); if(json.length > 0) { currentParcelData = json[0]; loadProperty(json[0]); } } catch(e){} }
        
        map.on('click', async (e) => {
            if(document.getElementById('card').classList.contains('active')) closeCard();
            else fetchParcelAt(e.latlng.lat, e.latlng.lng);
        });

        function loadProperty(p) {
            document.getElementById('owner').innerText = p.owner_name;
            document.getElementById('address').innerText = p.address;
            document.getElementById('card').classList.add('active');
            
            if(activeLayer) map.removeLayer(activeLayer);
            if(p.geometry) {
                activeLayer = L.geoJSON(JSON.parse(p.geometry), { style: { color: "#ffcc00", weight: 4, fillOpacity: 0.1 } }).addTo(map);
                activeLayer.on('click', (e) => { L.DomEvent.stopPropagation(e); createStake(e.latlng.lat, e.latlng.lng, "Stake " + (stakes.length+1)); });
            }
        }

        // --- SAVING ---
        function saveProperty(silent=false) { if(activeLayer && currentParcelData) { const exists = savedItems.find(i => i.id === currentParcelData.id); if(!exists) { savedItems.push(currentParcelData); saveToStorage(); if(!silent) alert("Property Saved"); } } }
        function saveToStorage() { const combined = [...savedItems, ...stakes]; localStorage.setItem('landslide_saves', JSON.stringify(combined)); }
        function deleteItem(id, event) { event.stopPropagation(); savedItems = savedItems.filter(i => i.id !== id); saveToStorage(); renderSavedList(); }
        function renderSavedList() {
            const container = document.getElementById('savedListContainer'); container.innerHTML = "";
            savedItems.forEach(item => { const div = document.createElement('div'); div.className = 'saved-item'; div.innerHTML = `<div onclick="flyToItem(${item.id})" style="flex:1"><b>${item.owner_name}</b><br>${item.address}</div><div class="trash-btn" onclick="deleteItem(${item.id}, event)">üóëÔ∏è</div>`; container.appendChild(div); });
            if(stakes.length > 0) { const div = document.createElement('div'); div.className = 'saved-item'; div.innerHTML = `<div><b>üö© ${stakes.length} Stakes</b></div>`; stakes.forEach(s => { const r = document.createElement('div'); r.style.padding = "5px 10px"; r.style.fontSize="12px"; r.style.color="#666"; r.innerText = `#${s.number} - ${s.label}`; div.appendChild(r); }); container.appendChild(div); }
        }
        function flyToItem(id) { const item = savedItems.find(i => i.id === id); if(item) { currentParcelData = item; const geo = JSON.parse(item.geometry); map.flyTo([geo.coordinates[0][0][0][1], geo.coordinates[0][0][0][0]], 19); loadProperty(item); toggleSavedList(); } }

        // --- AUTH & CLOUD ---
        function openLogin() { if(currentUser) { if(confirm("Log out?")) { currentUser = null; updateMenuUser(); } } else document.getElementById('loginModal').classList.add('active'); }
        function closeLogin() { document.getElementById('loginModal').classList.remove('active'); }
        function toggleAuthMode() { isRegistering = !isRegistering; document.getElementById('authTitle').innerText = isRegistering ? "Register" : "Login"; document.getElementById('authLink').innerText = isRegistering ? "Login" : "Register"; }
        async function handleAuth() { const email = document.getElementById('email').value, pass = document.getElementById('password').value; if(!email || !pass) return alert("Fill all fields"); try { const res = await fetch(isRegistering ? '/api/register' : '/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pass}) }); const data = await res.json(); if(data.success) { currentUser = data.user; updateMenuUser(); closeLogin(); alert("Welcome!"); } else alert(data.message); } catch(e){ alert("Error"); } }
        function updateMenuUser() { const el = document.getElementById('userDisplay'); if(currentUser) { el.innerText = "üë§ " + currentUser.email; el.style.color = "green"; } else { el.innerText = "üë§ Login / Register"; el.style.color = "007bff"; } }
        
        async function saveToCloud() { if(!currentUser) return openLogin(); let name = prompt("Project Name:"); if(!name) return; const data = { properties: savedItems, stakes, date: new Date().toISOString() }; try { await fetch('/api/cloud/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:currentUser.id, name, data }) }); alert("Saved!"); } catch(e) { alert("Error"); } }
        async function loadFromCloud() { if(!currentUser) return openLogin(); try { const res = await fetch(`/api/cloud/load/${currentUser.id}`); const list = await res.json(); if(list.length === 0) return alert("No saves."); const data = (typeof list[0].data === 'string') ? JSON.parse(list[0].data) : list[0].data; clearMap(); if(data.properties) data.properties.forEach(p => savedItems.push(p)); if(data.stakes) data.stakes.forEach(s => { stakes.push(s); addStakeMarker(s); }); saveToStorage(); renderSavedList(); alert("Loaded: " + list[0].name); toggleMenu(); if(stakes.length > 0) map.flyTo([stakes[0].lat, stakes[0].lng], 19); } catch(e) { alert("Error"); } }
        
        function saveProjectFile() { const data = { date: new Date().toLocaleDateString(), properties: savedItems, stakes }; let f = prompt("Project Name:", "Survey"); if(!f) return; const l = document.createElement("a"); l.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); l.download = f + ".json"; document.body.appendChild(l); l.click(); document.body.removeChild(l); toggleMenu(); }
        function loadProjectFile(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { const d = JSON.parse(e.target.result); clearMap(); if(d.properties) d.properties.forEach(p => savedItems.push(p)); if(d.stakes) d.stakes.forEach(s => { stakes.push(s); addStakeMarker(s); }); saveToStorage(); renderSavedList(); alert("Project Loaded!"); toggleMenu(); if(stakes.length>0) map.flyTo([stakes[0].lat, stakes[0].lng], 19); } catch(x){alert("Error");} }; r.readAsText(f); }
        function exportToCSV() { let f = prompt("File Name:", "data"); if(!f) return; if(!f.endsWith('.csv')) f+='.csv'; let c = "Type,Name/ID,Details,Lat,Lng\n"; savedItems.forEach(i => c+=`Property,"${i.owner_name}","${i.address}",,\n`); stakes.forEach(s => c+=`Stake,${s.label},${s.number},${s.lat},${s.lng}\n`); const l = document.createElement("a"); l.href = encodeURI("data:text/csv;charset=utf-8," + c); l.download = f; document.body.appendChild(l); l.click(); document.body.removeChild(l); }
        
        // UI HELPERS
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); document.getElementById('menuOverlay').classList.toggle('active'); }
        function toggleLayer() { if(map.hasLayer(satellite)) { map.removeLayer(satellite); map.addLayer(street); } else { map.removeLayer(street); map.addLayer(satellite); } }
        function closeCard() { document.getElementById('card').classList.remove('active'); if(activeLayer) { map.removeLayer(activeLayer); activeLayer = null; } }
        function toggleSavedList() { renderSavedList(); document.getElementById('savedModal').classList.toggle('active'); }

        enableCompass(); initApp();
    </script>
</body>
</html>