<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>LandScout | Pro Hike & Survey</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìç</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #222; }
        #map { position: fixed; top: 60px; bottom: 0; left: 0; right: 0; z-index: 1; background:#202020; }
        
        .app-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; display: flex; align-items: center; padding: 0 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 20000; border-bottom: 1px solid #ddd; }
        .menu-btn { font-size: 24px; padding: 10px; cursor: pointer; color: #555; }
        .search-wrapper { position: relative; flex: 1; margin: 0 10px; background: #f5f5f5; border-radius: 4px; padding: 5px 10px; display: flex; align-items: center; border: 1px solid #ddd; }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 16px; color: #333; }
        .search-go-btn { background: #007bff; color: white; border-radius: 4px; padding: 6px 12px; font-size: 13px; font-weight: bold; cursor: pointer; margin-left: 5px; border: none; }
        
        #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; z-index: 99999; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; color: #333; }

        .mode-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(5px); color: white; padding: 15px; border-radius: 16px; z-index: 10005; display: none; flex-direction: column; align-items: center; box-shadow: 0 8px 30px rgba(0,0,0,0.6); width: 90%; max-width: 340px; border: 1px solid #333; }
        .mode-panel.active { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
        
        .hike-stats { display: flex; gap: 15px; margin-bottom: 10px; width: 100%; justify-content: center; }
        .stat-box { text-align: center; background: #333; padding: 8px 15px; border-radius: 8px; min-width: 80px; }
        .stat-val { font-size: 22px; font-weight: bold; color: #4CAF50; }
        .stat-label { font-size: 10px; color: #ccc; }

        .panel-controls { display: flex; gap: 8px; width: 100%; margin-top: 5px; }
        .panel-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 13px; transition: transform 0.1s; text-transform: uppercase; }
        .btn-stop { background: #444; color: #ff5252; } 
        .btn-save { background: #2196F3; color: white; }
        .btn-start { background: #4CAF50; color: white; }
        .btn-action { background: #FF9800; color: black; }

        .side-menu { position: fixed; top: 60px; left: 0; bottom: 0; width: 280px; background: white; z-index: 20001; transform: translateX(-100%); transition: transform 0.3s ease-out; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .side-menu.open { transform: translateX(0); }
        .menu-overlay { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 20000; display: none; }
        .menu-overlay.active { display: block; }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; font-weight: 600; color: #444; cursor: pointer; display: flex; align-items: center; gap: 15px; }

        .measure-box { position: fixed; top: 75px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 25px; border-radius: 30px; font-size: 16px; z-index: 10001; display: none; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .measure-box.visible { display: flex; }
        .measure-dot { background: #FF9800; border: 2px solid white; border-radius: 50%; cursor: grab; }

        .stake-container { position: relative; }
        .stake-emoji { font-size: 35px; text-shadow: 2px 2px 0px white; cursor: pointer; }
        .stake-number { position: absolute; bottom: 0; right: 0; background: black; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        
        .user-dot { width: 14px; height: 14px; background: #007bff; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 4px rgba(0,123,255,0.3); position: absolute; }
        
        .popup-img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; margin: 2px; }
        .popup-btn { background: #eee; border: 1px solid #ccc; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px; font-size: 12px; font-weight: 600; }

        #imageModal { position: fixed; inset: 0; z-index: 50000; display: none; background: black; flex-direction: column; align-items: center; justify-content: center; }
        #modalImage { max-width: 100%; max-height: 80vh; object-fit: contain; }

        .right-drawer { position: fixed; top: 60px; right: 0; bottom: 0; width: 85%; max-width: 320px; background: white; z-index: 20002; transform: translateX(100%); transition: transform 0.3s; box-shadow: -2px 0 10px rgba(0,0,0,0.2); }
        .right-drawer.open { transform: translateX(0); }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <input type="file" id="stakeCamInput" accept="image/*" style="display:none" onchange="window.handleStakePhoto(this)">
    
    <div id="map"></div>

    <!-- MEASURE UI -->
    <div class="measure-box" id="measureBox">
        <span class="material-icons" style="color:#FF9800">straighten</span>
        <span id="distVal">Tap map to measure</span>
        <div onclick="toggleMeasureMode()" style="margin-left:10px; cursor:pointer">‚úï</div>
    </div>
    
    <!-- HIKE PANEL -->
    <div class="mode-panel" id="hikePanel">
        <div id="hikeStartUI" style="width:100%; text-align:center">
            <div style="margin-bottom:15px; color:#aaa; font-weight:bold">ü•æ READY TO TRACK?</div>
            <button class="panel-btn btn-start" style="width:100%" onclick="startHikeRecording()">START HIKE</button>
        </div>
        <div id="hikeActiveUI" style="display:none; width:100%;">
            <div class="hike-stats">
                <div class="stat-box"><div class="stat-val" id="hikeDist">0.00</div><div class="stat-label">MILES</div></div>
                <div class="stat-box"><div class="stat-val" id="hikeTime">00:00</div><div class="stat-label">TIME</div></div>
            </div>
            <div class="panel-controls">
                <button class="panel-btn btn-action" onclick="takeHikePhoto()"><span class="material-icons">camera_alt</span> Photo</button>
                <button class="panel-btn btn-save" onclick="finishAndSaveHike()">Finish</button>
            </div>
        </div>
    </div>

    <!-- APP BAR -->
    <div class="app-bar">
        <div class="menu-btn" onclick="toggleMenu()"><span class="material-icons">menu</span></div>
        <div class="search-wrapper">
            <input type="text" class="search-input" id="searchBox" placeholder="Search address...">
            <div class="search-go-btn" onclick="performSearch()">GO</div>
            <div id="suggestions"></div>
        </div>
    </div>

    <!-- SIDE MENU -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="handleAuth()"><span class="material-icons">person</span> <span id="loginText">Login / Register</span></div>
        <div style="padding:20px; font-size:12px; color:#999; font-weight:bold">TOOLS</div>
        <div class="menu-item" onclick="openHikePanel()"><span class="material-icons" style="color:#FF9800">hiking</span> Track My Hike</div>
        <div class="menu-item" onclick="toggleMeasureMode()"><span class="material-icons" style="color:#666">straighten</span> Measure Distance</div>
        <div class="menu-item" onclick="openHikeList()"><span class="material-icons" style="color:#2196F3">history</span> Saved Hikes</div>
    </div>

    <!-- IMAGE VIEWER -->
    <div id="imageModal">
        <img id="modalImage">
        <div style="margin-top:20px;">
            <button class="panel-btn btn-stop" onclick="document.getElementById('imageModal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- SAVED LIST -->
    <div class="right-drawer" id="listModal">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #ddd">Saved Hikes</div>
        <div id="listContainer" style="overflow-y:auto; height:calc(100% - 50px)"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { center: [40.7, -74.0], zoom: 12, zoomControl: false });
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20 }).addTo(map);

        let currentUserId = localStorage.getItem('ls_uid'), currentUserEmail = localStorage.getItem('ls_email');
        let stakes = [], stakeMarkers = {}, currentLatLng = null, userMarker = null;
        let isHiking = false, hikePath = [], hikePolyline = null, hikeSeconds = 0, hikeInterval = null, hikeStakes = [];
        let isMeasuring = false, measureMarkers = [], measurePolyline = null, measureLayer = L.layerGroup().addTo(map);

        if(currentUserEmail) document.getElementById('loginText').innerText = `Logout (${currentUserEmail.split('@')[0]})`;

        // --- GPS ---
        map.locate({watch:true, enableHighAccuracy:true});
        map.on('locationfound', (e)=>{
            currentLatLng = e.latlng;
            if(!userMarker) userMarker = L.marker(e.latlng, {icon: L.divIcon({className:'u', html:'<div class="user-dot"></div>', iconSize:[14,14]})}).addTo(map);
            else userMarker.setLatLng(e.latlng);
            if(isHiking) updateHikePosition(e.latlng);
        });

        // --- HIKE LOGIC ---
        function openHikePanel() { toggleMenu(); document.getElementById('hikePanel').classList.add('active'); }
        
        function startHikeRecording() {
            document.getElementById('hikeStartUI').style.display='none';
            document.getElementById('hikeActiveUI').style.display='block';
            isHiking = true; hikePath = []; hikeStakes = []; hikeSeconds = 0;
            hikePolyline = L.polyline([], {color:'#FF9800', weight:6}).addTo(map);
            hikeInterval = setInterval(() => {
                hikeSeconds++;
                const m = Math.floor(hikeSeconds/60), s = hikeSeconds%60;
                document.getElementById('hikeTime').innerText = `${m}:${s<10?'0'+s:s}`;
            }, 1000);
        }

        function updateHikePosition(ll) {
            if(hikePath.length > 0 && map.distance(ll, hikePath[hikePath.length-1]) < 3) return;
            hikePath.push(ll);
            hikePolyline.setLatLngs(hikePath);
            let d = 0;
            for(let i=0; i<hikePath.length-1; i++) d += map.distance(hikePath[i], hikePath[i+1]);
            document.getElementById('hikeDist').innerText = (d * 0.000621371).toFixed(2);
        }

        function takeHikePhoto() {
            if(!currentLatLng) return alert("Waiting for GPS...");
            const sid = Date.now();
            const n = stakes.length + 1;
            const s = { id: sid, lat: currentLatLng.lat, lng: currentLatLng.lng, label: "Hike Photo "+n, number: n, photos: [] };
            stakes.push(s); hikeStakes.push(s);
            addStakeMarker(s);
            window.selectedStakeId = sid;
            document.getElementById('stakeCamInput').click();
        }

        async function finishAndSaveHike() {
            if(!currentUserId) return alert("Please login to save hikes.");
            const name = prompt("Name your hike:");
            if(!name) return;
            const body = {
                userId: currentUserId,
                name: name,
                distance: parseFloat(document.getElementById('hikeDist').innerText) * 5280,
                path: hikePath,
                stakes: hikeStakes
            };
            const res = await fetch('/api/hikes/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
            if((await res.json()).success) {
                alert("Hike Saved!");
                location.reload();
            }
        }

        // --- PHOTO HANDLER ---
        window.handleStakePhoto = async function(input) {
            if(!input.files[0] || !window.selectedStakeId) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch('/api/image/upload', { method:'POST', body: formData });
                const d = await res.json();
                if(d.success) {
                    const s = stakes.find(x => x.id === window.selectedStakeId);
                    s.photos.push(d.url);
                    updateStakePopup(s);
                    stakeMarkers[s.id].openPopup();
                }
            } catch(e) { alert("Upload failed"); }
        };

        function addStakeMarker(s) {
            const m = L.marker([s.lat, s.lng], {
                icon: L.divIcon({className:'s', html:`<div class="stake-container"><div class="stake-emoji">üö©</div><div class="stake-number">${s.number}</div></div>`, iconSize:[40,40], iconAnchor:[20,20]})
            }).addTo(map);
            stakeMarkers[s.id] = m;
            m.bindPopup(() => {
                let imgs = s.photos.map(p => `<img src="${p}" class="popup-img" onclick="openImage('${p}')">`).join('');
                return `<div style="text-align:center"><b>${s.label}</b><div style="display:flex; flex-wrap:wrap">${imgs}</div></div>`;
            });
        }
        function updateStakePopup(s) { stakeMarkers[s.id].setPopupContent(stakeMarkers[s.id].getPopup().getContent()); }
        function openImage(u) { document.getElementById('modalImage').src = u; document.getElementById('imageModal').style.display='flex'; }

        // --- MEASURE TOOL ---
        function toggleMeasureMode() {
            isMeasuring = !isMeasuring;
            toggleMenu();
            document.getElementById('measureBox').classList.toggle('visible', isMeasuring);
            if(!isMeasuring) { measureLayer.clearLayers(); measureMarkers=[]; measurePolyline=null; }
        }

        map.on('click', (e) => {
            if(!isMeasuring) return;
            const m = L.marker(e.latlng, { draggable: true, icon: L.divIcon({className:'measure-dot', iconSize:[12,12]}) }).addTo(measureLayer);
            measureMarkers.push(m);
            m.on('drag', updateMeasure);
            updateMeasure();
        });

        function updateMeasure() {
            const pts = measureMarkers.map(m => m.getLatLng());
            if(pts.length < 2) return;
            if(!measurePolyline) measurePolyline = L.polyline(pts, {color:'orange', dashArray:'5,10'}).addTo(measureLayer);
            else measurePolyline.setLatLngs(pts);
            let d = 0;
            for(let i=0; i<pts.length-1; i++) d += pts[i].distanceTo(pts[i+1]);
            document.getElementById('distVal').innerText = (d * 3.28084).toFixed(1) + " ft";
        }

        // --- UI & AUTH ---
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); document.getElementById('menuOverlay').classList.toggle('active'); }
        
        async function handleAuth() {
            if(currentUserId) { if(confirm("Logout?")) { localStorage.clear(); location.reload(); } return; }
            const email = prompt("Email:");
            const pass = prompt("Password:");
            const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, password:pass}) });
            const d = await res.json();
            if(d.success) {
                localStorage.setItem('ls_uid', d.user.id);
                localStorage.setItem('ls_email', d.user.email);
                location.reload();
            } else alert(d.message);
        }

        async function openHikeList() {
            toggleMenu();
            if(!currentUserId) return alert("Login first");
            const res = await fetch(`/api/hikes/list/${currentUserId}`);
            const data = await res.json();
            const container = document.getElementById('listContainer');
            container.innerHTML = data.map(h => `
                <div class="list-item">
                    <div onclick="loadHike(${h.id})"><b>${h.name}</b><br><small>${(h.distance_ft/5280).toFixed(2)} mi</small></div>
                    <button onclick="deleteHike(${h.id})">üóë</button>
                </div>
            `).join('');
            document.getElementById('listModal').classList.add('open');
        }

        async function loadHike(id) {
            const res = await fetch(`/api/hikes/get/${id}`);
            const h = await res.json();
            document.getElementById('listModal').classList.remove('open');
            L.polyline(h.path_json, {color:'blue', weight:5}).addTo(map);
            h.stakes_json.forEach(addStakeMarker);
            map.fitBounds(L.polyline(h.path_json).getBounds());
        }

        async function performSearch() {
            const q = document.getElementById('searchBox').value;
            const res = await fetch(`/api/address/search?q=${encodeURIComponent(q)}`);
            const d = await res.json();
            if(d.lat) map.flyTo([d.lat, d.lng], 18);
        }
    </script>
</body>
</html>