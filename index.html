<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Landslide</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìç</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- CORE --- */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #222; }
        #map { position: fixed; top: 60px; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* --- UI ELEMENTS --- */
        .app-bar { 
            position: fixed; top: 0; left: 0; right: 0; height: 60px; 
            background: white; display: flex; align-items: center; padding: 0 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 200000; border-bottom: 1px solid #ddd; 
        }
        .menu-btn { font-size: 24px; padding: 10px; cursor: pointer; color: #555; }
        .search-wrapper { 
            flex: 1; margin: 0 10px; background: #f5f5f5; border-radius: 4px; 
            padding: 5px 10px; display: flex; align-items: center; border: 1px solid #ddd; 
        }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 16px; color: #333; }
        .search-go-btn { 
            background: #007bff; color: white; border-radius: 4px; padding: 6px 12px; 
            font-size: 13px; font-weight: bold; cursor: pointer; margin-left: 5px; border: none; 
        }
        .icon-btn { 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border-radius: 4px; 
        }
        
        /* --- SIDE MENU --- */
        .side-menu { 
            position: fixed; top: 60px; left: 0; bottom: 0; width: 280px; 
            background: white; z-index: 200001; 
            transform: translateX(-100%); transition: transform 0.3s ease-out; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; padding-top: 10px; 
        }
        .side-menu.open { transform: translateX(0); }
        .menu-overlay { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200000; display: none; }
        .menu-overlay.active { display: block; }
        .menu-item { 
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0; 
            font-weight: 600; color: #444; cursor: pointer; display: flex; align-items: center; gap: 15px; 
        }

        /* --- INFO CARD (With Drive Button) --- */
        .info-card { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            background: white; border-radius: 12px; padding: 15px 20px; 
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 10000; box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .info-card.active { transform: translateY(0); }
        .prop-info { flex: 1; }
        .prop-val { font-size: 16px; font-weight: 800; color: #000; line-height: 1.2; margin-bottom: 2px; }
        .prop-sub { font-size: 13px; color: #666; }
        .direction-btn { 
            background: #2196F3; color: white; padding: 10px 15px; border-radius: 8px; 
            font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 5px; cursor: pointer; 
        }

        /* --- MEASURE BOX --- */
        .measure-box { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 25px; border-radius: 30px; 
            font-size: 18px; font-weight: bold; z-index: 10001; display: none; 
            white-space: nowrap; border: 2px solid white; cursor:pointer;
        }
        .measure-box.visible { display: flex; align-items: center; gap: 15px; }

        /* --- LOGIN & PROJECT LISTS --- */
        .modal-bg { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); z-index: 300000; display: none; align-items: center; justify-content: center; 
        }
        .modal-box { 
            background: white; width: 300px; padding: 25px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; max-height: 80vh; overflow-y: auto;
        }
        .login-input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-btn { width: 100%; padding: 10px; background: #5E35B1; color: white; border: none; border-radius: 5px; font-weight: bold; margin-top:5px; }
        .list-item { 
            padding: 15px; border-bottom: 1px solid #eee; text-align: left; display: flex; justify-content: space-between; 
        }
        .trash-btn { color: #ff4400; cursor: pointer; padding-left: 10px; }

        /* --- MARKERS & GPS --- */
        .gps-pulse { 
            box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); animation: pulse-blue 2s infinite; 
            border-radius: 50%; cursor: pointer !important; 
        }
        @keyframes pulse-blue { 
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); } 
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); } 
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); } 
        }
        .stake-container { position: relative; }
        .stake-emoji { font-size: 35px; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); cursor: grab; }
        .stake-number { 
            position: absolute; bottom: 0; right: 0; background: black; color: white; 
            border-radius: 50%; width: 18px; height: 18px; font-size: 11px; 
            display: flex; align-items: center; justify-content: center; border: 1px solid white; 
        }
        .popup-img { width: 80px; height: 80px; object-fit: cover; margin: 2px; border: 1px solid #ccc; }
        
        .debug-label { position: fixed; bottom: 5px; left: 5px; background: #4CAF50; color: white; font-weight: bold; padding: 2px 6px; z-index: 99999; font-size: 10px; border:1px solid white; }
    </style>
</head>
<body>

    <div class="debug-label">v90 Stable</div>

    <!-- Hidden Inputs -->
    <input type="file" id="fileInput" accept=".landslide" style="display:none" onchange="handleRestoreBackup(this)">
    <input type="file" id="stakeCamInput" accept="image/*" capture="environment" style="display:none" onchange="handleStakePhoto(this)">

    <!-- MEASURE -->
    <div class="measure-box" id="measureBox">
        <span style="font-size:14px; margin-right:5px;">Tap map to measure:</span>
        <span id="distVal" style="color:#4CAF50;">0 ft</span>
        <div class="clear-measure" onclick="toggleMeasureMode()">‚úï</div>
    </div>

    <!-- MENU -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-item" id="loginItem" onclick="openLogin()">
            <span class="material-icons" style="color:#5E35B1">person</span> <span id="loginText">Login / Register</span>
        </div>
        <div class="menu-item" onclick="flyToUser(); toggleMenu();">
            <span class="material-icons" style="color:#E91E63">my_location</span> Go to Current Location
        </div>
        <div class="menu-item" onclick="toggleMeasureMode(); toggleMenu();">
            <span class="material-icons" style="color:#666">straighten</span> Measure Distance
        </div>
        <div class="menu-item" onclick="shareLocation()">
            <span class="material-icons" style="color:#2196F3">share</span> Share My Location
        </div>
        
        <hr style="width:100%;border:0;border-top:1px solid #eee;margin:5px 0;">
        <div class="menu-item" onclick="saveToCloud()">
            <span class="material-icons" style="color:#4CAF50">cloud_upload</span> Save to Cloud Account
        </div>
        <div class="menu-item" onclick="openListCloudProjects()">
            <span class="material-icons" style="color:#FF9800">cloud_download</span> Open from Account
        </div>
        
        <hr style="width:100%;border:0;border-top:1px solid #eee;margin:5px 0;">
        <!-- BACKUP & RESTORE -->
        <div class="menu-item" onclick="exportFullArchive()">
            <span class="material-icons" style="color:#607D8B">inventory_2</span> Backup to File
        </div>
        <div class="menu-item" onclick="document.getElementById('fileInput').click()">
            <span class="material-icons" style="color:#607D8B">upload_file</span> Restore from Backup
        </div>
        <div class="menu-item" onclick="inviteFriends()">
            <span class="material-icons" style="color:#666">link</span> Invite Friends
        </div>
    </div>

    <!-- TOP BAR -->
    <div class="app-bar">
        <div class="menu-btn" onclick="toggleMenu()"><span class="material-icons">menu</span></div>
        <div class="search-wrapper">
            <input type="text" class="search-input" id="searchBox" placeholder="Search Address or PIN...">
            <div class="search-go-btn" onclick="performSearch()">GO</div>
        </div>
        <div class="top-icons">
            <div class="icon-btn" onclick="toggleLayer()" title="Layers"><span class="material-icons" style="color:#444">layers</span></div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div class="modal-bg" id="loginModal">
        <div class="modal-box">
            <h3>Login</h3>
            <input type="email" id="emailInput" class="login-input" placeholder="Email">
            <input type="password" id="passInput" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="doLogin()">Login</button>
            <button class="login-btn" style="background:#4CAF50;margin-top:10px" onclick="doRegister()">Create Account</button>
            <div onclick="document.getElementById('loginModal').style.display='none'" style="margin-top:15px; text-decoration:underline;">Cancel</div>
        </div>
    </div>

    <!-- PROJECT LIST MODAL -->
    <div class="modal-bg" id="projectsModal">
        <div class="modal-box" style="width: 85%; max-width: 400px;">
            <h3>Your Cloud Projects</h3>
            <div id="projectsListContainer" style="max-height: 300px; overflow-y: auto;">Loading...</div>
            <div onclick="document.getElementById('projectsModal').style.display='none'" style="margin-top:15px; text-decoration:underline; cursor:pointer">Close</div>
        </div>
    </div>

    <div id="map"></div>

    <!-- PROPERTY CARD -->
    <div class="info-card" id="card">
        <div class="prop-info">
            <div class="prop-val" id="owner">...</div>
            <div class="prop-sub" id="address">...</div>
        </div>
        <div class="direction-btn" onclick="getDirectionsToSelected()">
            <span class="material-icons" style="color:white">directions_car</span> 
            <span style="color:white; margin-left:5px;">Drive</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const street = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const map = L.map('map', { center: [40.764356, -73.973057], zoom: 18, layers: [satellite], zoomControl: false });

        let currentUserId = null, currentUserEmail = null;
        let currentProjectID = null, currentProjectName = null;
        let activeLayer = null, currentParcelData = null;
        let savedItems = [], stakes = [], stakeMarkers = {};
        let userMarker = null, currentLatLng = null, selectedStakeId = null;

        // 1. LOGIN & REGISTER (RESTORED)
        async function doLogin(){
            const e=document.getElementById('emailInput').value, p=document.getElementById('passInput').value;
            try{
                const r = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:e,password:p})});
                const d = await r.json();
                if(d.success){
                    currentUserId=d.user.id; currentUserEmail=d.user.email;
                    localStorage.setItem('landslide_auth_id',currentUserId);
                    localStorage.setItem('landslide_auth_email',currentUserEmail);
                    updateMenuLoginText();
                    document.getElementById('loginModal').style.display='none';
                    alert("Logged In!");
                } else alert(d.message);
            } catch(x){alert("Server Connection Error");}
        }
        function doRegister(){
            const e=document.getElementById('emailInput').value,p=document.getElementById('passInput').value;
            if(e&&p)fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:e,password:p})}).then(r=>r.json()).then(d=>alert(d.message||d.error));
        }
        function updateMenuLoginText(){ if(currentUserEmail)document.getElementById('loginText').innerText = "Hi, "+currentUserEmail.split('@')[0]; }
        function openLogin(){toggleMenu(); if(currentUserId){if(confirm("Logout?")){currentUserId=null;currentUserEmail=null;document.getElementById('loginText').innerText="Login/Register";localStorage.removeItem('landslide_auth_id');localStorage.removeItem('landslide_auth_email');}}else document.getElementById('loginModal').style.display='flex';}

        // 2. MAP LOGIC
        map.locate({watch:true, enableHighAccuracy:true});
        map.on('locationfound', (e)=>{
            currentLatLng=e.latlng;
            if(!userMarker){
                userMarker = L.circleMarker(e.latlng, { radius: 12, color: "white", fillColor: "#007bff", fillOpacity: 1, zIndexOffset: 1000, className: 'gps-pulse', interactive: true }).addTo(map);
                
                // CLICK BLUE DOT TO STAKE
                userMarker.on('click', (ev)=>{
                    L.DomEvent.stopPropagation(ev);
                    if(isMeasuring) addMeasurePoint(e.latlng);
                    else {
                        let n = getNextStakeNumber();
                        createStake(currentLatLng.lat, currentLatLng.lng, "Stake "+n);
                    }
                });
                userMarker.bindTooltip("Tap to Stake", {permanent:true, direction:"bottom", className:"gps-label", offset:[0,10]});
            } else userMarker.setLatLng(e.latlng);
        });

        function flyToUser(){ 
            if(currentLatLng){ 
                map.flyTo(currentLatLng, 20); 
                if(!isMeasuring) fetchParcelAt(currentLatLng.lat, currentLatLng.lng); 
            } else alert("Waiting for GPS..."); 
        }

        async function fetchParcelAt(lat,lng){ 
            try {
                const r = await fetch(`/api/parcels?lat=${lat}&lng=${lng}`);
                const j = await r.json();
                if(j.length>0){ currentParcelData=j[0]; loadProperty(j[0]); }
            } catch(e){}
        }

        // 3. STAKES & PHOTOS
        function createStake(lat,lng,l){ 
            const id=Date.now(); 
            const s={id,type:'stake',lat,lng,label:l,number:getNextStakeNumber(), photos:[]}; 
            addStakeMarker(s); stakes.push(s); saveToStorage(); 
        }
        
        function getNextStakeNumber() { if(stakes.length===0)return 1; let max=0; stakes.forEach(s=>{let n=s.number||0; if(n>max)max=n;}); return max+1; }
        
        function addStakeMarker(s){
            const html = `<div class="stake-container"><div class="stake-emoji">üö©</div><div class="stake-number">${s.number}</div></div>`;
            const f = L.marker([s.lat, s.lng], { draggable: true, icon: L.divIcon({className:'ci',html:html,iconSize:[40,40],iconAnchor:[20,20]})}).addTo(map);
            stakeMarkers[s.id]=f;
            updateStakePopup(s);
            f.on('dragend',(e)=>{ const n=e.target.getLatLng(); s.lat=n.lat; s.lng=n.lng; saveToStorage(); });
        }
        
        // PHOTO LOGIC
        function requestStakePhoto(sid){ selectedStakeId=sid; document.getElementById('stakeCamInput').click(); }
        function handleStakePhoto(input){
            if(input.files[0] && selectedStakeId){
                const r = new FileReader();
                r.onload = function(e){
                    // Compress image here if possible (omitted for brevity)
                    const stake = stakes.find(s=>s.id===selectedStakeId);
                    if(stake){
                        if(!stake.photos) stake.photos=[];
                        stake.photos.push(e.target.result);
                        updateStakePopup(stake);
                        saveToStorage();
                    }
                    selectedStakeId=null;
                };
                r.readAsDataURL(input.files[0]);
            }
        }
        
        function updateStakePopup(s) {
            let pHtml = "";
            if(s.photos && s.photos.length) s.photos.forEach(src => pHtml += `<img src="${src}" style="width:60px;height:60px;margin:2px;border:1px solid #ccc">`);
            
            const c = `<div style="min-width:140px">
                <b>#${s.number} ${s.label}</b>
                <div>${pHtml}</div>
                <div style="margin-top:10px">
                    <button onclick="requestStakePhoto(${s.id})">Add Photo</button> 
                    <button onclick="delStake(${s.id})" style="color:red">Delete</button>
                </div>
            </div>`;
            stakeMarkers[s.id].setPopupContent(c);
        }
        
        window.delStake=function(id){ if(stakeMarkers[id])map.removeLayer(stakeMarkers[id]); stakes=stakes.filter(s=>s.id!==id); delete stakeMarkers[id]; saveToStorage(); }

        // 4. SAVE & LOAD
        async function saveToCloud() {
            toggleMenu(); if(!currentUserId) return alert("Login first");
            let name = currentProjectName || prompt("Project Name:");
            if(!name) return;
            try {
                // Stripping photos to save database space (Hybrid logic can go here later)
                const res = await fetch('/api/cloud/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUserId, id:currentProjectID, name, data:{properties:savedItems, stakes:stakes}}) });
                const json = await res.json();
                if(json.success) { alert("Saved!"); currentProjectID = json.newId; currentProjectName=name; } else alert(json.message);
            } catch(e) { alert("Error saving"); }
        }

        async function openListCloudProjects() {
            toggleMenu(); if(!currentUserId) return alert("Login first");
            document.getElementById('projectsModal').style.display='flex';
            const c = document.getElementById('projectsListContainer'); c.innerHTML="Loading...";
            const res = await fetch(`/api/cloud/load/${currentUserId}?t=${Date.now()}`);
            availableProjects = await res.json();
            c.innerHTML = "";
            availableProjects.forEach((p,i)=>{
                c.innerHTML += `<div class="list-item" onclick="loadSpecificProject(${i})"><b>${p.name}</b> <span style="font-size:12px">${new Date(p.updated_at).toLocaleDateString()}</span></div>`;
            });
        }
        
        function loadSpecificProject(i){
            const p=availableProjects[i]; const d = (typeof p.data === 'string') ? JSON.parse(p.data) : p.data;
            clearMap(); 
            if(d.properties) d.properties.forEach(item => savedItems.push(item));
            if(d.stakes) d.stakes.forEach(s => { stakes.push(s); addStakeMarker(s); });
            currentProjectID=p.id; currentProjectName=p.name;
            saveToStorage();
            document.getElementById('projectsModal').style.display='none';
            alert("Project Loaded");
            if(stakes.length) map.flyTo([stakes[0].lat, stakes[0].lng], 19);
        }

        function saveToStorage(){ localStorage.setItem('landslide_saves', JSON.stringify([...savedItems, ...stakes])); }
        function clearMap() { stakes.forEach(s => { if(stakeMarkers[s.id]) map.removeLayer(stakeMarkers[s.id]); }); stakes = []; savedItems = []; stakeMarkers = {}; localStorage.removeItem('landslide_saves'); }

        // 5. CORE UI UTILS
        function toggleMenu(){const m=document.getElementById('sideMenu'); m.style.transform=m.style.transform==='translateX(0%)'?'translateX(-100%)':'translateX(0%)'; document.getElementById('menuOverlay').style.display = (m.style.transform==='translateX(0%)')?'block':'none';}
        function toggleLayer(){if(map.hasLayer(satellite)){map.removeLayer(satellite);map.addLayer(street);}else{map.removeLayer(street);map.addLayer(satellite);}}
        function shareLocation(){toggleMenu(); if(currentLatLng){const u=`https://www.google.com/maps/search/?api=1&query=${currentLatLng.lat},${currentLatLng.lng}`; if(navigator.share)navigator.share({title:'Loc',url:u}); else{navigator.clipboard.writeText(u);alert("Link Copied");}}}
        function getDirectionsToSelected() {
            let lat, lng;
            if (currentParcelData && currentParcelData.geometry) { const g=JSON.parse(currentParcelData.geometry); lat=g.coordinates[0][0][0][1]; lng=g.coordinates[0][0][0][0]; }
            else if(currentLatLng) { lat=currentLatLng.lat; lng=currentLatLng.lng; }
            else return alert("Select Property first");
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`);
        }
        
        // SEARCH
        const input=document.getElementById('searchBox'); input.addEventListener('keypress',(e)=>{if(e.key==='Enter')performSearch()});
        async function performSearch() { if(isMeasuring) {alert("Close ruler"); return;} const q=input.value; if(q.length<2)return; input.blur(); try{const r=await fetch(`/api/search?q=${q}`); const j=await r.json(); if(j.length>0){loadProperty(j[0]); map.flyTo([j[0].lat,j[0].lng],19);}}catch(e){} }
        
        function loadProperty(p){ 
            document.getElementById('owner').innerText=p.owner_name; document.getElementById('address').innerText=p.address; document.getElementById('card').classList.add('active'); 
            if(activeLayer) map.removeLayer(activeLayer);
            if(p.geometry) { 
                activeLayer=L.geoJSON(JSON.parse(p.geometry),{style:{color:"#ffcc00",weight:4,fillOpacity:0.1}}).addTo(map);
                activeLayer.on('click', (e)=>{L.DomEvent.stopPropagation(e); if(isMeasuring)addMeasurePoint(e.latlng); else createStake(e.latlng.lat,e.latlng.lng,"Stake");});
            }
        }
        
        // MEASURE
        let isMeasuring=false, measurePoints=[], measureLayer=L.layerGroup().addTo(map);
        function toggleMeasureMode(){ isMeasuring=!isMeasuring; const b=document.getElementById('measureBox'), c=document.getElementById('card'); if(isMeasuring){ b.style.display='flex'; c.classList.remove('active'); } else { b.style.display='none'; measureLayer.clearLayers(); measurePoints=[]; if(currentParcelData)c.classList.add('active'); } }
        function addMeasurePoint(ll) { L.circleMarker(ll, {radius:5,color:'orange'}).addTo(measureLayer); measurePoints.push(ll); if(measurePoints.length>1){L.polyline(measurePoints,{color:'orange'}).addTo(measureLayer);}}

        // EXPORT/BACKUP
        function exportFullArchive() { 
            const d = {projectName: currentProjectName, properties: savedItems, stakes: stakes}; 
            const blob = new Blob([JSON.stringify(d)], {type: "application/json"}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); a.href=url; a.download="backup.landslide"; a.click(); toggleMenu();
        }
        function handleRestoreBackup(input){
            const f=input.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=function(e){const d=JSON.parse(e.target.result); clearMap(); if(d.properties)savedItems=d.properties; if(d.stakes) d.stakes.forEach(s=>addStakeMarker(s)); saveToStorage(); alert("Restored!");}; r.readAsText(f);
        }
        function inviteFriends() { if(navigator.share)navigator.share({title:'Landslide', url:window.location.href}); else alert("Copy: "+window.location.href); toggleMenu(); }

        // INIT
        function initApp() {
            if(localStorage.getItem('landslide_auth_email')) { currentUserId=localStorage.getItem('landslide_auth_id'); currentUserEmail=localStorage.getItem('landslide_auth_email'); updateMenuLoginText(); }
            const s=localStorage.getItem('landslide_saves'); if(s) { const all=JSON.parse(s); savedItems=all.filter(i=>i.type!=='stake'); stakes=[]; all.filter(i=>i.type==='stake').forEach(x=>{stakes.push(x);addStakeMarker(x)}); }
            if(typeof DeviceOrientationEvent !== 'undefined') {window.addEventListener('deviceorientation', e=>{const el=document.getElementById('gpsArrow'); if(el) el.style.transform=`rotate(${e.webkitCompassHeading||e.alpha}deg)`;});}
        }
        initApp();
        map.on('click', (e)=>{if(isMeasuring)addMeasurePoint(e.latlng); else if(document.getElementById('card').classList.contains('active'))document.getElementById('card').classList.remove('active'); else fetchParcelAt(e.latlng.lat, e.latlng.lng);});
    </script>
</body>
</html>