<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Landslide</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #222; }
        
        /* MAP */
        #map { position: fixed; top: 60px; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* UI LAYERS */
        .app-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: white; display: flex; align-items: center; padding: 0 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 99999; border-bottom: 1px solid #ddd;
        }
        .menu-btn { font-size: 24px; padding: 10px; cursor: pointer; color: #333; }
        .search-wrapper { flex: 1; margin: 0 5px; background: #f0f2f5; border-radius: 8px; padding: 5px 10px; display: flex; align-items: center; border: 1px solid #ddd; }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 16px; }
        .search-go-btn { background: #007bff; color: white; border-radius: 5px; padding: 5px 10px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 5px; }
        
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 2px; }
        .icon-svg { width: 24px; height: 24px; fill: #333; }

        /* CARD */
        .info-card {
            position: fixed; bottom: 20px; left: 15px; right: 15px; 
            background: white; border-radius: 15px;
            padding: 20px;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #ddd;
        }
        .info-card.active { transform: translateY(0); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .prop-val { font-size: 18px; font-weight: 800; color: #000; line-height: 1.2; }
        .prop-sub { font-size: 14px; color: #666; margin-top: 4px; }
        
        .card-icons { display: flex; gap: 15px; }
        .mini-btn { cursor: pointer; font-size: 24px; color: #666; padding: 5px; }
        .mini-btn:hover { color: #000; }
        .save-active { color: #ff4400 !important; }

        /* SAVED DRAWER */
        .saved-modal {
            position: fixed; top: 60px; right: 0; bottom: 0; width: 85%; max-width: 320px;
            background: white; z-index: 10001; transform: translateX(100%); transition: transform 0.3s ease-out;
            display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.3);
        }
        .saved-modal.active { transform: translateX(0); }
        .saved-header { padding: 20px; background: #333; color: white; font-weight: bold; display: flex; justify-content: space-between; }
        .saved-list { flex: 1; overflow-y: auto; }
        .saved-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .trash-btn { padding: 10px; cursor: pointer; color: #ff4400; font-size: 18px; }

        /* SIDE MENU */
        .side-menu {
            position: fixed; top: 60px; left: 0; bottom: 0; width: 250px;
            background: white; z-index: 100000;
            transform: translateX(-100%); transition: transform 0.3s ease-out;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }
        .side-menu.open { transform: translateX(0); }
        .menu-item { padding: 20px; border-bottom: 1px solid #eee; font-weight: 600; color: #333; cursor: pointer; }
        .menu-overlay { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99998; display: none; }
        .menu-overlay.active { display: block; }

        .stake-icon { font-size: 35px; text-shadow: 2px 2px 0px white; cursor: grab; }
        .debug-label { position: fixed; bottom: 5px; left: 5px; background: #9C27B0; color: white; font-weight: bold; padding: 2px 6px; z-index: 99999; font-size: 10px; }
        
        /* GPS PULSE */
        .gps-pulse {
            box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
            animation: pulse-blue 2s infinite;
            border-radius: 50%;
            cursor: pointer !important;
        }
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }
    </style>
</head>
<body>

    <div class="debug-label">v29</div>

    <!-- HIDDEN FILE INPUT FOR LOADING -->
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadProjectFile(this)">

    <!-- MENU -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="saveProjectFile()">üíæ Save Project File</div>
        <div class="menu-item" onclick="document.getElementById('fileInput').click()">üìÇ Open Project File</div>
        <div class="menu-item" onclick="exportToCSV()">üì§ Export to Excel</div>
        <div class="menu-item" style="margin-top:auto; color:#666; font-weight:400">v29 - Landslide</div>
    </div>

    <!-- TOP BAR -->
    <div class="app-bar">
        <div class="menu-btn" onclick="toggleMenu()" title="Main Menu">‚â°</div>
        <div class="search-wrapper">
            <input type="text" class="search-input" id="searchBox" placeholder="Search...">
            <div class="search-go-btn" onclick="performSearch()" title="Search Property">GO</div>
        </div>
        <div class="icon-btn" onclick="toggleSavedList()" title="Saved Properties"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg></div>
        <div class="icon-btn" onclick="toggleLayer()" title="Switch Map View"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/></svg></div>
        <div class="icon-btn" id="gpsBtn" onclick="flyToUser()" title="Go to your current location"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg></div>
    </div>

    <!-- SAVED LIST -->
    <div class="saved-modal" id="savedModal">
        <div class="saved-header"><span>Saved</span><span onclick="toggleSavedList()" style="cursor:pointer; font-size:20px;">‚úï</span></div>
        <div class="saved-list" id="savedListContainer"></div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- CARD -->
    <div class="info-card" id="card">
        <div class="card-header">
            <div>
                <div class="prop-val" id="owner">...</div>
                <div class="prop-sub" id="address">...</div>
            </div>
            <div class="card-icons">
                <div class="mini-btn" id="saveIcon" onclick="saveProperty()" title="Save Property">üíæ</div>
                <div class="mini-btn" onclick="closeCard()" title="Close">‚úï</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const street = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 21 });
        const map = L.map('map', { center: [40.764356, -73.973057], zoom: 18, layers: [satellite], zoomControl: false });

        // --- GPS LOGIC ---
        let userMarker = null, currentLatLng = null;
        map.locate({ watch: true, enableHighAccuracy: true });

        map.on('locationfound', (e) => {
            currentLatLng = e.latlng;
            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                userMarker = L.circleMarker(e.latlng, { 
                    radius: 12, color: "white", fillColor: "#007bff", 
                    fillOpacity: 1, zIndexOffset: 1000, 
                    className: 'gps-pulse', interactive: true 
                }).addTo(map);

                // CLICK BLUE DOT TO AUTO-STAKE
                userMarker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    let nextNum = stakes.length + 1;
                    createStake(currentLatLng.lat, currentLatLng.lng, "Stake " + nextNum);
                });
                
                userMarker.bindTooltip("Tap to Stake", {permanent: false, direction: "top"});
            }
        });

        function flyToUser() {
            if(currentLatLng) map.flyTo(currentLatLng, 20);
            else alert("Finding GPS...");
        }

        // --- STAKE LOGIC ---
        let stakes = [];
        let stakeMarkers = {}; // Keep track of marker objects
        
        function createStake(lat, lng, label) {
            const id = Date.now();
            const stakeData = { id: id, type: 'stake', lat: lat, lng: lng, label: label };
            addStakeMarker(stakeData);
            stakes.push(stakeData);
            saveToStorage();
        }

        function addStakeMarker(s) {
            const hammer = L.marker([s.lat, s.lng], {
                draggable: true,
                icon: L.divIcon({ className: 'stake-icon', html: 'üî®', iconSize: [40, 40], iconAnchor: [5, 40] })
            }).addTo(map);
            
            hammer.bindPopup(`<b>${s.label}</b><br><button onclick="window.removeStakeByBtn(${s.id})">Delete</button>`);

            hammer.on('dragend', (e) => {
                const newPos = e.target.getLatLng();
                s.lat = newPos.lat; s.lng = newPos.lng;
                saveToStorage();
            });
            
            stakeMarkers[s.id] = hammer; // Store ref
        }

        window.removeStakeByBtn = function(id) {
            if(stakeMarkers[id]) map.removeLayer(stakeMarkers[id]);
            removeStake(id);
        }

        function removeStake(id) {
            stakes = stakes.filter(s => s.id !== id);
            delete stakeMarkers[id];
            saveToStorage();
        }

        // --- SAVE / LOAD SYSTEM (NEW) ---
        
        // 1. Save Project to File (.json)
        function saveProjectFile() {
            const data = {
                date: new Date().toLocaleDateString(),
                properties: savedItems,
                stakes: stakes
            };
            const jsonStr = JSON.stringify(data);
            
            let fileName = prompt("Name your project:", "Survey_Project");
            if(!fileName) return;
            
            const link = document.createElement("a");
            link.href = "data:text/json;charset=utf-8," + encodeURIComponent(jsonStr);
            link.download = fileName + ".json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            toggleMenu(); // Close menu
        }

        // 2. Load Project from File
        function loadProjectFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Clear current data
                    clearMap();
                    
                    // Restore Data
                    if(data.properties) {
                        data.properties.forEach(p => {
                            savedItems.push(p);
                            // Only draw active one? No, maybe just load data
                        });
                    }
                    if(data.stakes) {
                        data.stakes.forEach(s => {
                            stakes.push(s);
                            addStakeMarker(s);
                        });
                    }
                    
                    saveToStorage();
                    renderSavedList();
                    alert("Project Loaded Successfully!");
                    toggleMenu();
                    
                    // Zoom to first stake or property
                    if(stakes.length > 0) map.flyTo([stakes[0].lat, stakes[0].lng], 19);
                    
                } catch(err) {
                    alert("Error loading file: " + err);
                }
            };
            reader.readAsText(file);
        }

        function clearMap() {
            // Remove all existing stakes from map
            stakes.forEach(s => {
                if(stakeMarkers[s.id]) map.removeLayer(stakeMarkers[s.id]);
            });
            stakes = [];
            savedItems = [];
            stakeMarkers = {};
            localStorage.removeItem('landslide_saves');
        }

        // --- UI & SEARCH ---
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); document.getElementById('menuOverlay').classList.toggle('active'); }
        function toggleLayer() {
            if (map.hasLayer(satellite)) { map.removeLayer(satellite); map.addLayer(street); }
            else { map.removeLayer(street); map.addLayer(satellite); }
        }

        const input = document.getElementById('searchBox');
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        
        async function performSearch() {
            const q = input.value; if(q.length < 2) return; input.blur();
            document.querySelector('.search-go-btn').innerText = "...";
            try {
                const res = await fetch(`/api/search?q=${q}`);
                const json = await res.json();
                document.querySelector('.search-go-btn').innerText = "GO";
                if(json.length > 0) {
                    loadProperty(json[0]);
                    map.flyTo([json[0].lat, json[0].lng], 19);
                } else alert("No results.");
            } catch(e) { document.querySelector('.search-go-btn').innerText = "GO"; }
        }

        let activeLayer = null, currentParcelData = null, savedItems = [];
        
        function initApp() { 
            const stored = localStorage.getItem('landslide_saves'); 
            if (stored) {
                const allData = JSON.parse(stored);
                // Handle legacy format (array) vs new object format
                let allItems = Array.isArray(allData) ? allData : []; 
                
                savedItems = allItems.filter(i => i.type !== 'stake');
                const savedStakes = allItems.filter(i => i.type === 'stake');
                savedStakes.forEach(s => { addStakeMarker(s); stakes.push(s); });
            }
        }

        map.on('click', async (e) => {
            try {
                const res = await fetch(`/api/parcels?lat=${e.latlng.lat}&lng=${e.latlng.lng}`);
                const json = await res.json();
                if(json.length > 0) { currentParcelData = json[0]; loadProperty(json[0]); } 
                else closeCard();
            } catch(e) {}
        });

        function loadProperty(p) {
            document.getElementById('owner').innerText = p.owner_name;
            document.getElementById('address').innerText = p.address;
            document.getElementById('saveIcon').classList.remove('save-active');
            document.getElementById('card').classList.add('active');
            
            if(activeLayer) map.removeLayer(activeLayer);
            if(p.geometry) {
                activeLayer = L.geoJSON(JSON.parse(p.geometry), { 
                    style: { color: "#ffcc00", weight: 4, fillOpacity: 0.1 } 
                }).addTo(map);
            }
        }

        function saveProperty() {
            if(activeLayer && currentParcelData) {
                savedItems.push(currentParcelData); saveToStorage(); 
                document.getElementById('saveIcon').classList.add('save-active');
            }
        }

        function saveToStorage() {
            const combined = [...savedItems, ...stakes];
            localStorage.setItem('landslide_saves', JSON.stringify(combined));
        }

        function deleteItem(id, event) {
            event.stopPropagation(); savedItems = savedItems.filter(i => i.id !== id);
            saveToStorage(); renderSavedList();
        }

        function toggleSavedList() { renderSavedList(); document.getElementById('savedModal').classList.toggle('active'); }
        
        function renderSavedList() {
            const container = document.getElementById('savedListContainer'); container.innerHTML = "";
            savedItems.forEach(item => {
                const div = document.createElement('div'); div.className = 'saved-item';
                div.innerHTML = `<div onclick="flyToItem(${item.id})" style="flex:1"><b>${item.owner_name}</b><br>${item.address}</div><div class="trash-btn" onclick="deleteItem(${item.id}, event)">üóëÔ∏è</div>`;
                container.appendChild(div);
            });
            if(stakes.length > 0) {
                const div = document.createElement('div'); div.className = 'saved-item';
                div.innerHTML = `<div><b>üî® ${stakes.length} Stakes</b></div>`;
                stakes.forEach(s => {
                    const r = document.createElement('div');
                    r.style.padding = "5px 10px"; r.style.fontSize="12px"; r.style.color="#666";
                    r.innerText = `‚Ä¢ ${s.label} (${s.lat.toFixed(5)}, ${s.lng.toFixed(5)})`;
                    div.appendChild(r);
                });
                container.appendChild(div);
            }
        }

        function flyToItem(id) {
            const item = savedItems.find(i => i.id === id);
            if(item) {
                currentParcelData = item; const geo = JSON.parse(item.geometry);
                map.flyTo([geo.coordinates[0][0][0][1], geo.coordinates[0][0][0][0]], 19); loadProperty(item); toggleSavedList();
            }
        }

        function exportToCSV() {
            let csv = "Type,Info,Lat,Lng\n";
            savedItems.forEach(i => csv += `Property,"${i.address}",,\n`);
            stakes.forEach(s => csv += `Stake,${s.label},${s.lat},${s.lng}\n`);
            const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "landslide_data.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function closeCard() { 
            document.getElementById('card').classList.remove('active'); 
            if(activeLayer) { map.removeLayer(activeLayer); activeLayer = null; } 
        }
        
        initApp(); 
    </script>
</body>
</html>